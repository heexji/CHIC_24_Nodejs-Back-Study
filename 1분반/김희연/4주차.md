# Node.js 2장 Chapter 01~22

## 01 수업 소개

MySQL: 가장 보편적인 데이터 베이스(보안, 안정성, 성능, 동시성 등 관리)

애플리케이션에서 데이터 저장 기능을 파일에서 데이터베이스로 변경하려면 readdir이나 readfile처럼 파일을 제어하는 코드를 수정해야 함. 

## 02 실습 준비

**MySQL Server:** 실제 데이터를 저장하고 관리하는 서버 역할, 데이터베이스를 운영하기 위한 핵심 소프트웨어

**MySQL Workbench:** 사용자 친화적인 인터페이스를 통해 데이터베이스를 설계하고 관리하는 데 사용, 서버와 상호 작용하여 사용자가 더 쉽게 데이터베이스를 관리하고 쿼리를 수행할 수 있도록 돕는 도구

```jsx
**C:\Program Files\MySQL\MySQL Workbench 8.0>mysql -uroot -p**
**Enter password: **********
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 21
Server version: 8.0.38 MySQL Community Server - GPL

Copyright (c) 2000, 2024, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

**mysql> CREATE DATABASE opentutorials; // opentutorials라는 데이터베이스 생성**
Query OK, 1 row affected (0.02 sec)

**mysql> show databases;** 
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| opentutorials      |
| performance_schema |
| sakila             |
| sys                |
| world              |
+--------------------+
7 rows in set (0.00 sec)

**mysql> use opentutorials;**
Database changed
mysql> --                          // 테이블을 생성하기 위한 SQL문
mysql> -- Table structure for table `author`
mysql> --
mysql>
mysql>
mysql> CREATE TABLE `author` (
    ->     `id` int(11) NOT NULL AUTO_INCREMENT,
    ->     `name` varchar(20) NOT NULL,
    ->     `profile` varchar(200) DEFAULT NULL,

    ->     PRIMARY KEY (`id`)
    -> );
Query OK, 0 rows affected, 1 warning (0.05 sec)

mysql>
mysql> --
mysql> -- Dumping data for table `author`
mysql> --
mysql>
mysql> INSERT INTO `author` VALUES (1,'egoing','developer');
Query OK, 1 row affected (0.01 sec)

mysql> INSERT INTO `author` VALUES (2,'duru','database administrator');
Query OK, 1 row affected (0.01 sec)

mysql> INSERT INTO `author` VALUES (3,'taeho','data scientist, developer');
Query OK, 1 row affected (0.01 sec)

mysql>
mysql> --
mysql> -- Table structure for table `topic`
mysql> --
mysql>
mysql> CREATE TABLE `topic` (
    ->     `id` int(11) NOT NULL AUTO_INCREMENT,
    ->     `title` varchar(30) NOT NULL,
    ->     `description` text,
    ->     `created` datetime NOT NULL,
    ->     `author_id` int(11) DEFAULT NULL,
    ->     PRIMARY KEY (`id`)
    -> );
Query OK, 0 rows affected, 2 warnings (0.04 sec)

mysql>
mysql> --
mysql> -- Dumping data for table `topic`
mysql> --
mysql>
mysql> INSERT INTO `topic` VALUES (1,'MySQL','MySQL is...','2018-01-01 12:10:11',1);
Query OK, 1 row affected (0.01 sec)

mysql> INSERT INTO `topic` VALUES (2,'Oracle','Oracle is ...','2018-01-03 13:01:10',1);
Query OK, 1 row affected (0.01 sec)

mysql> INSERT INTO `topic` VALUES (3,'SQL Server','SQL Server is ...','2018-01-20 11:01:10',2);
Query OK, 1 row affected (0.01 sec)

mysql> INSERT INTO `topic` VALUES (4,'PostgreSQL','PostgreSQL is ...','2018-01-23 01:03:03',3);
Query OK, 1 row affected (0.00 sec)

mysql> INSERT INTO `topic` VALUES (5,'MongoDB','MongoDB is ...','2018-01-30 12:31:03',1);
Query OK, 1 row affected (0.01 sec)

**mysql> show tables;**
+-------------------------+
| Tables_in_opentutorials |
+-------------------------+
| author                  |
| topic                   |
+-------------------------+
2 rows in set (0.01 sec)

**mysql> select*from topic;**
+----+------------+-------------------+---------------------+-----------+
| id | title      | description       | created             | author_id |
+----+------------+-------------------+---------------------+-----------+
|  1 | MySQL      | MySQL is...       | 2018-01-01 12:10:11 |         1 |
|  2 | Oracle     | Oracle is ...     | 2018-01-03 13:01:10 |         1 |
|  3 | SQL Server | SQL Server is ... | 2018-01-20 11:01:10 |         2 |
|  4 | PostgreSQL | PostgreSQL is ... | 2018-01-23 01:03:03 |         3 |
|  5 | MongoDB    | MongoDB is ...    | 2018-01-30 12:31:03 |         1 |
+----+------------+-------------------+---------------------+-----------+
5 rows in set (0.00 sec)

**mysql> select*from author;**
+----+--------+---------------------------+
| id | name   | profile                   |
+----+--------+---------------------------+
|  1 | egoing | developer                 |
|  2 | duru   | database administrator    |
|  3 | taeho  | data scientist, developer |
+----+--------+---------------------------+
3 rows in set (0.00 sec)
```

- dependencies: 우리가 사용하는 애플리케이션이 의존하는 외부 라이브러리를 의미.(우리의 애플리케이션에서는 Node.js에서 사용한 sanitize-html모듈에 대한 의존성이 설정되어 있음.)
- >npm install을 통해 npm의 패키지 매니저가 이 명령어를 실행한 위치에서 package.json파일을 찾고 파일 안에 지정된 의존성 라이브러리들을 자동으로 설치함 —> node_modules라는 디렉터리가 생성되고 그 안에sanitize-html이 생성됨.

## 03 _mysql 모듈의 기본 사용법

nodejs디렉터리 아래에 mysql.js파일 생성

```jsx
var mysql      = require('mysql'); //mysql모듈을 mysql이라는 이름으로 사용하겠다는 선언
// 비밀번호는 별도의 파일로 분리해서 버전관리에 포함시키지 않아야 합니다. 
var connection = mysql.createConnection({  // 데이터베이스에 접속할 때 필요한 정보를 객체 형태로 mysql모듈에 있는 createConnection메서드에 인수로 전달
  host     : 'localhost',  // 데이터베이스가 있는 서버 주소
  user     : 'root',       // 사용자 이름
  password : '00001006',     // 비밀번호
  database : 'opentutorials'// 접속할 데이터베이스의 이름
});
// createConnection메서드가 리턴하는 결과를 connection변수에 저장 
connection.connect(); //connect메서드를 호출하여 데이터베이스에 접속
  
// query메서드를 이용하여 접속한 데이터베이스에 질의문 전달
connection.query('SELECT * FROM topic', function (error, results, fields) {    // topic테이블에 있는 모든 데이터를 읽어오는 질의문
    if (error) {   // 에러발생하면 콘솔에 에러 메시지 출력
        console.log(error); // 성공하면 두 번째 인수로 전달한 콜백 실행
    }
    console.log(results); // 콜백에서는 데이터베이스에 질의문을 전달한 결과를 두 번째 인수인 results로 받아서 출력
});
  
connection.end(); // 작업 마쳤으니 접속 끊는 end메서드를 호출
```

mysql.js파일 실행 결과

```jsx
PS C:\Users\huiye\OneDrive\바탕 화면\nodejs-master\nodejs-master\source\02_nodejs-mysql> node nodejs/mysql.js
[
  RowDataPacket {
    id: 1,
    title: 'MySQL',
    description: 'MySQL is...',
    created: 2018-01-01T03:10:11.000Z,
    author_id: 1
  },
  RowDataPacket {
    id: 2,
    title: 'Oracle',
    description: 'Oracle is ...',
    created: 2018-01-03T04:01:10.000Z,
    author_id: 1
  },
  RowDataPacket {
    id: 3,
    title: 'SQL Server',
    description: 'SQL Server is ...',
    author_id: 2
  },
  RowDataPacket {
    id: 4,
    title: 'PostgreSQL',
    description: 'PostgreSQL is ...',
    created: 2018-01-22T16:03:03.000Z,
    author_id: 3
  },
  RowDataPacket {
    id: 5,
    title: 'MongoDB',
    description: 'MongoDB is ...',
    created: 2018-01-30T03:31:03.000Z,
    author_id: 1
  }
]

// topic 테이블에 있는 모든 데이터를 읽어오는 질의
```

*에러가 발생하였다면 p.  292 참고

### 데이터베이스 처리 작업

: 접속 —> 질의문 —> 접속 종료

- ALL PRIVILEGES옵션: 모든 권한을 부여하겠다는 의미
- 권한 옵션: CREATE, DROP, DELETE, INSERT, SELECT, UPDATE, GRANT OPTION(다른 사용자에게 권한을 부여할 수 있는 권한)
- FLUSH PRIVILEGES 명령: 권한을 실제 데이터베이스에 적용

## 04 mysql모듈을 이용한 홈페이지 구현

우리가 개발한 Node.js애플리케이션에 mysql모듈을 적용하여 파일로 했던 데이터 보관과 처리를 데이터베이스로 변경하기

**main.js에다가 데이터베이스 접속 정보 정의**

```jsx
var mysql=require('mysql');

//연결 정보를 여러 상황에서 이용하고자 db객체에 담음.
var db = mysql.createConnection({
    host:'localhost',
    user:'root',
    password:'00001006',
    database:'opentutorlas'
});
db.connect(); //이를 통해 db에 담긴 연결 정보를 바탕으로 해당 데이터베이스에 접
```

**데이터를 데이터베이스에서 읽어와서 웹 페이지 생성**

```jsx
var app = http.createServer(function(request, response) {
    var _url = request.url;
    var queryData = url.parse(_url, true).query;
    var pathname = url.parse(_url, true).pathname;

    if(pathname === '/') {
        if(queryData.id === undefined) {
            db.query(`SELECT * FROM topic`, function(error, topics){      //  <--fs.readdir('./data', function(error, filelist) 이 부분 수정한 것.
                var title = 'Welcome';
                var description = 'Hello, Node.js';
                var list = template.list(topics);     //filelist --> topics으로 변경
                //template.list는 lib폴더에 있는 template.js파일의 list메서드를 의미함. 파일을 이용했을 떄는 이 list메서드에 전달한 인수가 파일 목록(filelist)이었지만, 데이터베이스에서 가져온 데이터는 topics에 담겨 있으므로 topics를 잔달함. 따라서 list메서드의 매개변수 이름도 topics로 변경함. 
                var html = template.HTML(title, list,
                    `<h2>${title}</h2><p>${description}</p>`,
                    `<a href="/create">create</a>`
                );
                response.writeHead(200);
                response.end(html);
            });
        }
```

db객체의 query메서드를 이용하여 데이터베이스에 질의

—> query메서드의 첫 번째 인자는 데이터베이스에 질의할 내용

—> 두 번째 인자는 질의문을 실행한 다음 응답받을 때 호출되는 콜백, 콜백의 첫 번째 매개변수는 에러가 발생했을 때 전달받는 에러 메시지이고 두 번째 매개변수는 성공했을 때 전달받는 메시지가 담김.

—> 전달된 정보는 배열 안에 객체가 담긴 형태

**template.js파일의 list메서의 부분 수정**

```jsx
list:function(topics) {
        var list = '<ul>';
        var i = 0;
        while(i < topics.length) {
            list = list + `<li><a href="/?id=${topics[i].id}">${topics[i].title}</a></li>`;
            i = i + 1;
        }
        list = list+'</ul>';
        return list;
    }
```

topics[i] : 객체를 가리킴

topics[i].title : title프로퍼티를 가리킴

—> topics에 담긴 데이터들이 배열 안에 객체의 형태로 들어가 있기 때문에 topics[i].title로 수정해야 우리가 원하는 제목들이 나옴.

—> id도 title처럼 객체 자체가 아닌 객체의 속성 중 id값으로 표시되게 수정함. id 값은 각각의 행을 식별하는,  숫자로 된 유일무이한 중복되지 않는 식별자임. 

## 05 mysql로 상세 보기 구현

```jsx
// 기존 코드의 상세 보기 기능에 해당하는 코드
else {
            fs.readdir('./data', function(error, filelist) {
                var filteredId = path.parse(queryData.id).base;
                fs.readFile(`data/${filteredId}`, 'utf8', function(err, description) {
                    var title = queryData.id;
                    var sanitizedTitle = sanitizeHtml(title);
                    var sanitizedDescription = sanitizeHtml(description, {
                        allowedTags:['h1']
                    });
                    var list = template.list(filelist);
                    var html = template.HTML(sanitizedTitle, list,
                        `<h2>${sanitizedTitle}</h2><p>${sanitizedDescription}</p>`,
                        `<a href="/create">create</a>
                        <a href="/update?id=${sanitizedTitle}">update</a>
                        <form action="delete_process" method="post">
                            <input type="hidden" name="id" value="${sanitizedTitle}">
                            <input type="submit" value="delete">
                        </form>`
                    );
                    response.writeHead(200);
                    response.end(html);
                });
            });
        }
```

p.308수정

```jsx
var title=topic[0].title;
           var description=topic[0].description;
                var title = 'Welcome';
                var description = 'Hello, Node.js';
```

```jsx
// 수정전
db.query(`SELECT * FROM topic WHERE id=${queryData.id}`, function(error2, topic){
                    if(error2){
                        throw error2;
                    }
                    
                    
// 더 안전한 방법으로 수정(보안)                    
db.query(`SELECT * FROM topic WHERE id=?`, [queryData.id], function(error2, topic){
                    if(error2){
                        throw error2;
                    }
```

⇒ [queryData.id]에 지정한 값이 SQL문에서 물음표로 표시한 곳에 치환되는데, 이때 공격 의도가 있는 코드를 알아서 걸러주는 역할을 함. 

## 06 mysql을 이용한 글 생성 기능 구현

데이터베이스에 정보를 쓰는 기능(데이터베이스에 직접 데이터를 추가하는 방법이 아닌 사용자가 온라인에서 데이터를 삽입하는 방법)

create링크를 클릭했을 때 보이는 글 생성 화면 수, 데이터를 추가하는 create_process 수정

```jsx
else if(pathname === '/create'){
      db.query(`SELECT * FROM topic`, function(error,topics){
        var title = 'Create';
        var list = template.list(topics);
        var html = template.HTML(title, list,
          `
          <form action="/create_process" method="post">
            <p><input type="text" name="title" placeholder="title"></p>
            <p>
              <textarea name="description" placeholder="description"></textarea>
            </p>
            <p>
              <input type="submit">
            </p>
          </form>
          `,
          `<a href="/create">create</a>`
        );
        response.writeHead(200);
        response.end(html);
      });
    } else if(pathname === '/create_process'){
      var body = '';
      request.on('data', function(data){
          body = body + data;
      });
      request.on('end', function(){
          var post = qs.parse(body);
          db.query(`
            INSERT INTO topic (title, description, created, author_id) 
              VALUES(?, ?, NOW(), ?)`,
            [post.title, post.description, 1], 
            function(error, result){
              if(error){
                throw error;
              }
              response.writeHead(302, {Location: `/?id=${result.insertId}`});
              response.end();
            }
          )
      });
    } 
```

- 웹 페이지에서 제목과 내용을 입력한 후 [submit]버튼을 누르면 해당 정보가 데이터베이스에 저장되도록 수정됨.
- [submit]버튼을 클릭하면 폼에 입력한 정보가 /create_process로 전달됨.

INSERT INTO SQL문

```jsx
INSERT INTO topic (title description, created, author_id) // topic테이블에 데이터를 삽입하겠다는 의미(소괄호 안에 컬럼명이 적힌 것)
VALUES(?,?,NOW(),1); // 각 칼럼에 저장할 실제 값을 차례로 나열
```

—> 새로운 데이터를 추가하는 SQL문

—> NOW()함수: 현재 시각을 나타내는 SQL의 내장 함수

## 07 mysql로 글 수정 기능 구현

```jsx
else if(pathname === '/update'){
        db.query('SELECT * FROM topic', function(error, topics){
          if(error){
            throw error;
          }
          db.query(`SELECT * FROM topic WHERE id=?`,[queryData.id], function(error2, topic){
            if(error2){
              throw error2;
            }
            var list = template.list(topics);
            var html = template.HTML(topic[0].title, list,
              `
              <form action="/update_process" method="post">
                <input type="hidden" name="id" value="${topic[0].id}">
                <p><input type="text" name="title" placeholder="title" value="${topic[0].title}"></p>
                <p>
                  <textarea name="description" placeholder="description">${topic[0].description}</textarea>
                </p>
                <p>
                  <input type="submit">
                </p>
              </form>
              `,
              `<a href="/create">create</a> <a href="/update?id=${topic[0].id}">update</a>`
            );
            response.writeHead(200);
            response.end(html);
          });
        });
      } else if(pathname === '/update_process'){
        var body = '';
        request.on('data', function(data){
            body = body + data;
        });
        request.on('end', function(){
            var post = qs.parse(body);
            db.query('UPDATE topic SET title=?, description=?, author_id=1 WHERE id=?', [post.title, post.description, post.id], function(error, result){
              response.writeHead(302, {Location: `/?id=${post.id}`});
              response.end();
            })
        });
    }
```

- SQL문에서 WHERE절을 이용해서 수정할 글의 id값을 반드시 지정해야함→ 그러지 않으면 모든 행의 데이터가 수정됨.

## 08 mysql로 글 삭제 기능 구현

```jsx
else if(pathname === '/delete_process'){
        var body = '';
        request.on('data', function(data){
            body = body + data;
        });
        request.on('end', function(){
            var post = qs.parse(body);
            db.query('DELETE FROM topic WHERE id = ?', [post.id], function(error, result){
              if(error){
                throw error;
              }
              response.writeHead(302, {Location: `/`});
              response.end();
            });
        });
    }
```

- SQL문에서 WHERE절을 이용해서 삭제할 글의 id를 반드시 지정해야 함→ 그러지 않으면 모든 행의 데이터가 삭제됨.

## 09 JOIN을 이용한 상세 보기 구현

author 테이블: 작성자 정보를 담고 있는 테이블

topic테이블과 author테이블의 author_id값이 같다는 관계성이 있음

→ 두 테이블을 합쳐서 표현하려면 JOIN이라는 SQL문 이용

```jsx
mysql> SELECT * FROM topic LEFT JOIN author ON topic.author_id=author.id;
+----+------------+-------------------+---------------------+-----------+------+--------+---------------------------+
| id | title      | description       | created             | author_id | id   | name   | profile                   |
+----+------------+-------------------+---------------------+-----------+------+--------+---------------------------+
|  1 | MySQL      | MySQL is...       | 2018-01-01 12:10:11 |         1 |    1 | egoing | developer                 |
|  2 | Oracle     | Oracle is ...     | 2018-01-03 13:01:10 |         1 |    1 | egoing | developer                 |
|  3 | SQL Server | SQL Server is ... | 2018-01-20 11:01:10 |         2 |    2 | duru   | database administrator    |
|  4 | PostgreSQL | PostgreSQL is ... | 2018-01-23 01:03:03 |         3 |    3 | taeho  | data scientist, developer |
|  5 | MongoDB    | MongoDB is ...    | 2018-01-30 12:31:03 |         1 |    1 | egoing | developer                 |
|  6 |            |                   | 2024-07-23 00:15:06 |         1 |    1 | egoing | developer                 |
+----+------------+-------------------+---------------------+-----------+------+--------+---------------------------+
6 rows in set (0.00 sec)

```

—> topic테이블을 왼쪽에 두고 author테이블을 오른쪽에 나란히 붙이는 명령어.

—> topic.author_id=author.id: topic테이블의 author_id값과 일치하는author테이블의 id값을  이용하여 합친다는 의미.

글의 상세 보기 페이지에 작성자를 함께 표시(JOIN문을 이용하여 SQL질의 수정)

```jsx
 else {
        db.query(`SELECT * FROM topic`, function(error,topics){
         if(error){
           throw error;
         }
         db.query(`SELECT * FROM topic LEFT JOIN author ON topic.author_id=author.id WHERE topic.id=?`,[queryData.id], function(error2, topic){
           if(error2){
             throw error2;
           }
           console.log(topic);
          var title = topic[0].title;
          var description = topic[0].description;
          var list = template.list(topics);
          var html = template.HTML(title, list,
            `<h2>${title}</h2>
            ${description}
            <p>by ${topic[0].name}</p>`,
            ` <a href="/create">create</a>
                <a href="/update?id=${queryData.id}">update</a>
                <form action="delete_process" method="post">
                  <input type="hidden" name="id" value="${queryData.id}">
                  <input type="submit" value="delete">
                </form>`
          );
          response.writeHead(200);
          response.end(html);
         })
      });
      }
```

—> WHERE절의 id를 topic.id로 해야함. id칼럼은 두 테이블에 모두 존재하므로 어떤 테이블의 id값인지 모호해질 수 있으므로 명확히 지정해야함.

—>  <p>by ${topic[0].name}</p> 이를추가하여 상세 보기 페이지에 작성자 정보도 함께 출력되도록 함.

 

## 10 글 생성 구현

글을 생성할 때 작성자를 선택할 수 있는 기능 구현(create요청을 처리하는 부분에 구현)

mysql> SELECT * FROM author;  // 작성자 목록 가져오는 SQL문

작성자 목록 가져오는 코드 추가

```jsx
db.query(`SELECT * FROM topic`, function(error,topics){
        db.query('SELECT * FROM author', function(error2,authors){
```

—> 기존에 글 목록을 불러오는 질의 블록 안에 작성자 목록을 불러오는 질의를 추가함.

작성자를 선택할 수 있는 코드 추가

```jsx
 else if(pathname === '/create'){
      db.query(`SELECT * FROM topic`, function(error,topics){
        db.query('SELECT * FROM author', function(error2,authors){
            console.log(authors);

        var tag='';  // tag라는 빈 문자열을 담은 변수 하나 선언, authors에 담긴 데이터를 콤보 박스로 표현하는 HTML코드를 담음.
        var i=0;
        while(i<authors.length){
            tag +=`<option value="${authors[i].id}">${authors[i].name}</option>`;
            i++;
        }
        var title = 'Create';
        var list = template.list(topics);
        var html = template.HTML(title, list,
           `
          <form action="/create_process" method="post">
            <p><input type="text" name="title" placeholder="title"></p>
            <p>
              <textarea name="description" placeholder="description"></textarea>
            </p>
            <p>
               ${template.authorSelect(authors)}
            </p>
            <p>
              <input type="submit">
            </p>
          </form>
          `,
          `<a href="/create">create</a>`
        );
        response.writeHead(200);
        response.end(html);
       });

      });
    }
```

1. 가져온 작성자 목록을 이용하여 작성자를 선택할 수 있는 콤보 박스 만들기 (콤보 박스는 <select>태그를 사용하며 이 태그에 name을 지정하면 전송하는 데이터의 이름이 됨.)
2. template.js 파일 수정(작성자를 출력하는 콤보 박스를 템플릿으로 분리
3. 템플릿을 이용하여 콤보 박스를 출력하도록 수정

template.js 파일

```
list:function(topics){
      var list = '<ul>';
      var i = 0;
      while(i < topics.length){
        list = list + `<li><a href="/?id=${topics[i].id}">${topics[i].title}</a></li>`;
        i = i + 1;
      }
      list = list+'</ul>';
      return list;
    },authorSelect:function(authors){
      var tag = '';
      var i = 0;
      while(i < authors.length){
        tag += `<option value="${authors[i].id}">${authors[i].name}</option>`;
        i++;
      }
      return `
        <select name="author">
          ${tag}
        </select>
      `
    }
  }
```

글을 생성할 때 작성자 정보도 함께 저장(사용자가 콤보 박스에서 작성자를 선택하고 [submit]버튼을 눌렀을 때 그 정보를 받아서 처리하는 부분)

```jsx
else if(pathname === '/create_process'){
      var body = '';
      request.on('data', function(data){
          body = body + data;
      });
      request.on('end', function(){
          var post = qs.parse(body);
          db.query(`
            INSERT INTO topic (title, description, created, author_id) 
              VALUES(?, ?, NOW(), ?)`,
            [post.title, post.description, post.author], 
            function(error, result){
              if(error){
                throw error;
              }
              response.writeHead(302, {Location: `/?id=${result.insertId}`});
              response.end();
            }
          )
      });
    }
```

임시로 1이라고 저장해둔 코드를 post.author로 바꿈 

—> 사용자가 선택한 작성자 이름이 데이터베이스에 저장되도록 수정한 것.
           

## 11 글 수정 구현

글을 수정하는 기능에서 글쓴이를 수정할 수 있게 구현(update요청을 처리하는 부분에 구현)

글 수정 페이지에 작성자 목록 출력

```jsx
else if(pathname === '/update'){
        db.query('SELECT * FROM topic', function(error, topics){
          if(error){
            throw error;
          }
          db.query(`SELECT * FROM topic WHERE id=?`,[queryData.id], function(error2, topic){
            if(error2){
              throw error2;
            }
            db.query(`SELECT * FROM author`, function(error2,authors) {
            var list = template.list(topics);
            var html = template.HTML(topic[0].title, list,
              `
              <form action="/update_process" method="post">
                <input type="hidden" name="id" value="${topic[0].id}">
                <p><input type="text" name="title" placeholder="title" value="${topic[0].title}"></p>
                <p>
                  <textarea name="description" placeholder="description">${topic[0].description}</textarea>
                </p>
                <p>
                  ${template.authorSelect(authors, topic[0].author_id)}
                  </p>
                <p>
                  <input type="submit">
                </p>
              </form>
              `,
              `<a href="/create">create</a> <a href="/update?id=${topic[0].id}">update</a>`
            );
            response.writeHead(200);
            response.end(html);
             });
          });
        });
      }
```

1. /update에서 글을 불러오는 질의 불록 안에 글쓴이를 불러오는 질의를 추가
2. 글쓴이를 수정할 수 있게 템플릿의 authorSelect를 이용하여 글쓴이 목록을 표시
3. ${template.authorSelect(authors, topic[0].author_id)} : 수정 페이지에서는 현재 값, 즉 수정하려는 글의 작성자가 콤보 박스에 보여야 하므로 authorSelect메서드의 두 번째 인자로 현재 작성자를 전달
4. template.js파일에서도 authorSelect함수에서 두 번째 인수를 처리하는 코드를 추가해야 함

template.js

```jsx
authorSelect:function(authors, author_id) {
      var tag = '';
      var i = 0;
      while(i < authors.length){
        var selected='';
        if(authors[i].id ===author_id){
            selected='selected';
          }
        tag += `<option value="${authors[i].id}"${selected}>${authors[i].name}</option>`;
        i++;
      }
      return `
        <select name="author">
          ${tag}
        </select>
      `
      }
```

authorSelect함수에 author_id라는 두 번째 매개변수 추가, 반복문에서 조건문을 이용해 반복문 안에서 현재 차례의 작성자 id(author[i].id)와 두 번째 매개변수로 전달 받은 작성자가 같은지 확인

—> 만약 같다면 <option>태그에 selected속성을 추가하게 함.

글을 수정할 때 작성자 정보도 함께 수정

```jsx
else if(pathname === '/update_process'){
        var body = '';
        request.on('data', function(data){
            body = body + data;
        });
        request.on('end', function(){
            var post = qs.parse(body);
            db.query('UPDATE topic SET title=?, description=?, author_id=? WHERE id=?', [post.title, post.description, post.author, post.id], function(error, result){
              response.writeHead(302, {Location: `/?id=${post.id}`});
              response.end();
            })
        });
    }
```

UPDATE문에서 작성자 아이디가 1로 돼 있던 부분을 물음표로 수정하고, 이에 해당하는 값으로 post.author를 지정

main.js 최종

```jsx
var http = require('http');
var fs = require('fs');
var url = require('url');
var qs = require('querystring');
var template = require('./lib/template.js');
var path = require('path');
var sanitizeHtml = require('sanitize-html');
var mysql = require('mysql');
var db = mysql.createConnection({
  host:'localhost',
  user:'root',
  password:'00001006',
  database:'opentutorials'
});
db.connect();
 
 
var app = http.createServer(function(request,response){
    var _url = request.url;
    var queryData = url.parse(_url, true).query;
    var pathname = url.parse(_url, true).pathname;
    if(pathname === '/'){
      if(queryData.id === undefined){
        db.query(`SELECT * FROM topic`, function(error,topics){
          var title = 'Welcome';
          var description = 'Hello, Node.js';
          var list = template.list(topics);
          var html = template.HTML(title, list,
            `<h2>${title}</h2>${description}`,
            `<a href="/create">create</a>`
          );
          response.writeHead(200);
          response.end(html);
        });
      } else {
        db.query(`SELECT * FROM topic`, function(error,topics){
         if(error){
           throw error;
         }
         db.query(`SELECT * FROM topic LEFT JOIN author ON topic.author_id=author.id WHERE topic.id=?`,[queryData.id], function(error2, topic){
           if(error2){
             throw error2;
           }
           console.log(topic);
          var title = topic[0].title;
          var description = topic[0].description;
          var list = template.list(topics);
          var html = template.HTML(title, list,
            `<h2>${title}</h2>
            ${description}
            <p>by ${topic[0].name}</p>`,
            ` <a href="/create">create</a>
                <a href="/update?id=${queryData.id}">update</a>
                <form action="delete_process" method="post">
                  <input type="hidden" name="id" value="${queryData.id}">
                  <input type="submit" value="delete">
                </form>`
          );
          response.writeHead(200);
          response.end(html);
         })
      });
      }
    } else if(pathname === '/create'){
      db.query(`SELECT * FROM topic`, function(error,topics){
        db.query('SELECT * FROM author', function(error2,authors){
        var title = 'Create';
        var list = template.list(topics);
        var html = template.HTML(title, list,
           `
          <form action="/create_process" method="post">
            <p><input type="text" name="title" placeholder="title"></p>
            <p>
              <textarea name="description" placeholder="description"></textarea>
            </p>
            <p>
              ${template.authorSelect(authors)}
            </p>
            <p>
              <input type="submit">
            </p>
          </form>
          `,
          `<a href="/create">create</a>`
        );
        response.writeHead(200);
        response.end(html);
       });

      });
    } else if(pathname === '/create_process'){
      var body = '';
      request.on('data', function(data){
          body = body + data;
      });
      request.on('end', function(){
          var post = qs.parse(body);
          db.query(`
            INSERT INTO topic (title, description, created, author_id) 
              VALUES(?, ?, NOW(), ?)`,
            [post.title, post.description, post.author], 
            function(error, result){
              if(error){
                throw error;
              }
              response.writeHead(302, {Location: `/?id=${result.insertId}`});
              response.end();
            }
          )
      });
    } else if(pathname === '/update'){
        db.query('SELECT * FROM topic', function(error, topics){
          if(error){
            throw error;
          }
          db.query(`SELECT * FROM topic WHERE id=?`,[queryData.id], function(error2, topic){
            if(error2){
              throw error2;
            }
            db.query(`SELECT * FROM author`, function(error2,authors) {
            var list = template.list(topics);
            var html = template.HTML(topic[0].title, list,
              `
              <form action="/update_process" method="post">
                <input type="hidden" name="id" value="${topic[0].id}">
                <p><input type="text" name="title" placeholder="title" value="${topic[0].title}"></p>
                <p>
                  <textarea name="description" placeholder="description">${topic[0].description}</textarea>
                </p>
                <p>
                  ${template.authorSelect(authors, topic[0].author_id)}
                  </p>
                <p>
                  <input type="submit">
                </p>
              </form>
              `,
              `<a href="/create">create</a> <a href="/update?id=${topic[0].id}">update</a>`
            );
            response.writeHead(200);
            response.end(html);
             });
          });
        });
      } else if(pathname === '/update_process'){
        var body = '';
        request.on('data', function(data){
            body = body + data;
        });
        request.on('end', function(){
            var post = qs.parse(body);
            db.query('UPDATE topic SET title=?, description=?, author_id=? WHERE id=?', [post.title, post.description, post.author, post.id], function(error, result){
              response.writeHead(302, {Location: `/?id=${post.id}`});
              response.end();
            })
        });
    } else if(pathname === '/delete_process'){
        var body = '';
        request.on('data', function(data){
            body = body + data;
        });
        request.on('end', function(){
            var post = qs.parse(body);
            db.query('DELETE FROM topic WHERE id = ?', [post.id], function(error, result){
              if(error){
                throw error;
              }
              response.writeHead(302, {Location: `/`});
              response.end();
            });
        });
    } else {
      response.writeHead(404);
      response.end('Not found');
    }
});
app.listen(3000);
```

## 13 Node.js 의 DB 설정 정보 정리

.lib/db.js

```jsx
var mysql=require('mysql'); 

//데이터베이스 접속 코드 작성

var db = mysql.createConnection({
    host:'localhost',
    user:'root',
    password:'00001006',
    database:'opentutorials'
  });
  db.connect();

  module.exports=db; // db모듈을 외부에서 사용할 수 있게 export
```

main.js에서의 모듈 정리

```jsx
var http = require('http');
var url = require('url');
var qs = require('querystring');
var template = require('./lib/template.js');
var db = require('./lib/db.js'); //데이터베이스 접속 코드 불러오기
```

## 14 Node.js 코드 정리

./lib/topic.js

```jsx
var db=require('./db.js'); //여기에서 db와 template객체를 사용할 수 있게 불러오기 , 같은 lib디렉토리에 존재하므로 경로 지정할 떄 lib는 제외함.
var template=require('./template.js');
var url=require('url'); 
var qs=require('querystring');

//main.js에서 글(topic)과 관련된 코드 --> home이라는 이름의 함수로 만들어 사용

exports.home=function(request, response) {
    db.query(`SELECT * FROM topic`, function(error,topics){
        var title = 'Welcome';
        var description = 'Hello, Node.js';
        var list = template.list(topics);
        var html = template.HTML(title, list,
          `<h2>${title}</h2>${description}`,
          `<a href="/create">create</a>`
        );
        response.writeHead(200);
        response.end(html);
      });
}

// main.js에서 상세 보기 페이지의 코드
exports.page=function(request,response){
    var _url = request.url;
    var queryData=url.parse(_url, true).query;
    db.query(`SELECT * FROM topic`, function(error,topics){
        if(error){
          throw error;
        }
        db.query(`SELECT * FROM topic LEFT JOIN author ON topic.author_id=author.id WHERE topic.id=?`,[queryData.id], function(error2, topic){
          if(error2){
            throw error2;
          }
          console.log(topic);
         var title = topic[0].title;
         var description = topic[0].description;
         var list = template.list(topics);
         var html = template.HTML(title, list,
           `<h2>${title}</h2>
           ${description}
           <p>by ${topic[0].name}</p>`,
           ` <a href="/create">create</a>
               <a href="/update?id=${queryData.id}">update</a>
               <form action="delete_process" method="post">
                 <input type="hidden" name="id" value="${queryData.id}">
                 <input type="submit" value="delete">
               </form>`
         );
         response.writeHead(200);
         response.end(html);
        });
     });
    }
   

    //main.js에서 글 생성 화면 코드
    exports.create=function(request,response){
        db.query(`SELECT * FROM topic`, function(error,topics){
            db.query('SELECT * FROM author', function(error2,authors){
            var title = 'Create';
            var list = template.list(topics);
            var html = template.HTML(title, list,
               `
              <form action="/create_process" method="post">
                <p><input type="text" name="title" placeholder="title"></p>
                <p>
                  <textarea name="description" placeholder="description"></textarea>
                </p>
                <p>
                  ${template.authorSelect(authors)}
                </p>
                <p>
                  <input type="submit">
                </p>
              </form>
              `,
              `<a href="/create">create</a>`
            );
            response.writeHead(200);
            response.end(html);
           });
    
        });
    }

    // main.js에서 글 생성을 처리하는 코드
    exports.create_process=function(request,response){
        var body = '';
      request.on('data', function(data){
          body = body + data;
      });
      request.on('end', function(){
          var post = qs.parse(body);
          db.query(`
            INSERT INTO topic (title, description, created, author_id) 
              VALUES(?, ?, NOW(), ?)`,
            [post.title, post.description, post.author], 
            function(error, result){
              if(error){
                throw error;
              }
              response.writeHead(302, {Location: `/?id=${result.insertId}`});
              response.end();
            }
          )
      });
    }

    //main.js에서 글 수정 화면의 코드
    exports.update=function(request,response){
        var _url=request.url;
        var queryData=url.parse(_url,true).query;
        db.query('SELECT * FROM topic', function(error, topics){
            if(error){
              throw error;
            }
            db.query(`SELECT * FROM topic WHERE id=?`,[queryData.id], function(error2, topic){
              if(error2){
                throw error2;
              }
              db.query(`SELECT * FROM author`, function(error2,authors) {
              var list = template.list(topics);
              var html = template.HTML(topic[0].title, list,
                `
                <form action="/update_process" method="post">
                  <input type="hidden" name="id" value="${topic[0].id}">
                  <p><input type="text" name="title" placeholder="title" value="${topic[0].title}"></p>
                  <p>
                    <textarea name="description" placeholder="description">${topic[0].description}</textarea>
                  </p>
                  <p>
                    ${template.authorSelect(authors, topic[0].author_id)}
                    </p>
                  <p>
                    <input type="submit">
                  </p>
                </form>
                `,
                `<a href="/create">create</a> <a href="/update?id=${topic[0].id}">update</a>`
              );
              response.writeHead(200);
              response.end(html);
               });
            });
          });
    }

    //main.js에서 글 수정을 처리하는 코드
    exports.update_process=function(request,response){
        var body = '';
        request.on('data', function(data){
            body = body + data;
        });
        request.on('end', function(){
            var post = qs.parse(body);
            db.query('UPDATE topic SET title=?, description=?, author_id=? WHERE id=?', [post.title, post.description, post.author, post.id], function(error, result){
              response.writeHead(302, {Location: `/?id=${post.id}`});
              response.end();
            })
        });
    }

    //main.js에서 글 삭제를 처리하는 코드
    exports.delete_process=function(request,response){
        var body = '';
        request.on('data', function(data){
            body = body + data;
        });
        request.on('end', function(){
            var post = qs.parse(body);
            db.query('DELETE FROM topic WHERE id = ?', [post.id], function(error, result){
              if(error){
                throw error;
              }
              response.writeHead(302, {Location: `/`});
              response.end();
            });
        });

    }

```

—> 첫 줄에 export대신 exports지정한 이유: topic.js라는 모듈은 바깥쪽에서 사용할 수 있게 여러 함수를 외부로 공유할 것. 따라서 여러 개의 API를 제공할 것이므로 export가 아닌 exports를 사용.

- 하나만 제공할 때는 module.export를 사용
- 여러 개를 제공할 때는 module.exports를 사용

main.j

```jsx
var http = require('http');
var url = require('url');
var qs = require('querystring');
var template = require('./lib/template.js');
var db = require('./lib/db.js'); //데이터베이스 접속 코드 불러오기
var topic=require('./lib/topic');// topic라이브러리에 있는 함수들 호출
 
var app = http.createServer(function(request,response){
    var _url = request.url;
    var queryData = url.parse(_url, true).query;
    var pathname = url.parse(_url, true).pathname;
    if(pathname === '/'){
      if(queryData.id === undefined){
        topic.home(request, response);
      } else {
        topic.page(request,response);
      }
    } else if(pathname === '/create'){
      topic.create(request,response);
    } else if(pathname === '/create_process'){
      topic.create_process(request,response);
    } else if(pathname === '/update'){
        topic.update(request,response);
      } else if(pathname === '/update_process'){
        topic.update_process(request,response);
    } else if(pathname === '/delete_process'){
        topic.delete_process(request,response);
    } else {
      response.writeHead(404);
      response.end('Not found');
    }
});
app.listen(3000);
```

## 15 저자 관리 기능 구현

지금까지 애플리케이션에서 글(토픽)에만 집중했지만, 지금부터는 저자 정보를 대상으로 CRUD를 처리해볼 것.

## 16 저자 목록 보기 기능 구현

template.js에다가 저자 목록을 보여주는 author링크 HTML코드로 추가

```jsx
HTML:function(title, list, body, control){
      return `
      <!doctype html>
      <html>
      <head>
        <title>WEB1 - ${title}</title>
        <meta charset="utf-8">
      </head>
      <body>
        <h1><a href="/">WEB</a></h1>
        <a href="/author>author</a> // 여기
        ${list}
        ${control}
        ${body}
      </body>
      </html>
      `;
```

- 테이블을 표시하는 HTML태그: <table>
- 각 컬럼:<td>태그로 감쌈
- 각 행:<tr>태그로 감쌈
- HTML에서는 <style>태그 안에 CSS코드를 작성

./lib/author.js

```jsx
var db = require('./db');
var template = require('./template.js');
exports.home = function(request, response){
    db.query(`SELECT * FROM topic`, function(error,topics){
        db.query(`SELECT * FROM author`, function(error2,authors){
            var title = 'author';
            var list = template.list(topics);
            var html = template.HTML(title, list,
            `
            ${template.authorTable(authors)}
            <style>
                table{
                    border-collapse: collapse;  // 테이블의 테두리와 셀(td)의 테두리 사이의 간격을 collapse로 지정, 속성값 collapse는 테두리 사이의 간격을 없애고 겹치는 부분을 한 줄로 나타냄. 
                }
                td{
                    border:1px solid black; // 셀 테두리, 두께, 종류, 색상 정의
                }
            </style>
            `,
            `<a href="/create">create</a>`
            );
            response.writeHead(200);
            response.end(html);
        });
    });
}
```

template.js

```jsx
// 표를 출력하는 코드 템플릿으로 분리

,authorTable:function(authors){
        var tag = '<table>';
        var i = 0;
        while(i < authors.length){
            tag += `
                <tr>
                    <td>${authors[i].name}</td>
                    <td>${authors[i].profile}</td>
                    <td>update</td>
                    <td>delete</td>
                </tr>
                `
            i++;
        }
        tag += '</table>';
        return tag;
      }
    }
```

## 17 저자 생성 기능 구현

저자를 추가하는 방법

author.js

```jsx
var db = require('./db');
var template = require('./template.js');
exports.home = function(request, response){
    db.query(`SELECT * FROM topic`, function(error,topics){
        db.query(`SELECT * FROM author`, function(error2,authors){
            var title = 'author';
            var list = template.list(topics);
            var html = template.HTML(title, list,
            `
            ${template.authorTable(authors)}
            <style>
                table{
                    border-collapse: collapse;
                }
                td{
                    border:1px solid black;
                }
            </style>
            `,
            `
            <form action="/author/create_process" method="post">
              <p>
                <input type="text" name="name" placeholder="name">
              </p>
              <p>
                <textarea name="profile" placeholder="description"></textarea>
              </p>
              <p>
                <input type="submit">
              </p>
            </form>
            `
            );
            response.writeHead(200);
            response.end(html);
        });
    });
}

exports.create_process=function(request,response){
    var body = '';
  request.on('data', function(data){
      body = body + data;
  });
  request.on('end', function(){
      var post = qs.parse(body);
      db.query(`
        INSERT INTO author (name, profile) 
          VALUES(?, ?)`,
        [post.name, post.profile], 
        function(error, result){
          if(error){
            throw error;
          }
          response.writeHead(302, {Location: `/author`});
          response.end();
        }
      )
  });
}
```

—> 저자 목록 화면 아래에 저자를 추가하는 폼 만들기

—> 저자를 추가하는 요청을 처리(create_process)

main.js

```jsx
var http = require('http');
var url = require('url');
var qs = require('querystring');
var template = require('./lib/template.js');
var db = require('./lib/db.js'); //데이터베이스 접속 코드 불러오기
var topic=require('./lib/topic');// topic라이브러리에 있는 함수들 호출
var author=require('./lib/author')// author링크를 클릭하면 요청을 처리
 
var app = http.createServer(function(request,response){
    var _url = request.url;
    var queryData = url.parse(_url, true).query;
    var pathname = url.parse(_url, true).pathname;
    if(pathname === '/'){
      if(queryData.id === undefined){
        topic.home(request, response);
      } else {
        topic.page(request,response);
      }
    } else if(pathname === '/create'){
      topic.create(request,response);
    } else if(pathname === '/create_process'){
      topic.create_process(request,response);
    } else if(pathname === '/update'){
        topic.update(request,response);
      } else if(pathname === '/update_process'){
        topic.update_process(request,response);
    } else if(pathname === '/delete_process'){
        topic.delete_process(request,response);
    } else if(pathname === '/author'){
        author.home(request,response);
    }else if(pathname ==='/author/create_process'){    // 저자를 추가하는 요청을 처리하도록 추가
        author.create_process(request,response);
    } else {
      response.writeHead(404);
      response.end('Not found');
    }
});
app.listen(3000);
```

—>저자를 추가하는 요청을 처리하는 /author/create_process추가

## 18 저자 수정 기능 구현

template.js: 저자 정보 목록에 update링크 추가

```jsx
 <tr>
                    <td>${authors[i].name}</td>
                    <td>${authors[i].profile}</td>
                    <td><a href="/author/update?id=${authors[i].id}">update</a></td>
                    <td>delete</td>
                </tr>
```

author.js 

```jsx
exports.update = function(request, response){
  db.query(`SELECT * FROM topic`, function(error,topics){
      db.query(`SELECT * FROM author`, function(error2,authors){
        var _url=request.url;
        var queryData=url.parse(_url,true).query;
        db.query(`SELECT * FROM author WHERE id=?`,[queryData.id], function(error3,author){

          var title = 'author';
          var list = template.list(topics);
          var html = template.HTML(title, list,
          `
          ${template.authorTable(authors)}
          <style>
              table{
                  border-collapse: collapse;
              }
              td{
                  border:1px solid black;
              }
          </style>
          <form action="/author/update_process" method="post">
            <p>
              <input type="hidden" name="id" value="${queryData.id}">
            </p>
            <p>
               <input trpe="text name="name value="${author[0].name}" placeholder="name">
            </p>
            <p>
              <textarea name="profile" placeholder="description">${author[0].profile}</textarea>
            </p>
            <p>
              <input type="submit" value="update>
            </p>
          </form>
          `,
          ``
          );
          response.writeHead(200);
          response.end(html);
      });
    });
  });
}

exports.update_process = function(request, response){
  var body = '';
    request.on('data', function(data){
        body = body + data;
    });
    request.on('end', function(){
        var post = qs.parse(body);
        db.query(`
          UPDATE author SET name=?, profile=? WHERE id=?`,
          [post.name, post.profile, post.id], 
          function(error, result){
            if(error){
              throw error;
            }
            response.writeHead(302, {Location: `/author`});
            response.end();
          }
        )
    });
}
```

—> 저자를 수정하기 위한 폼을 요청하는 처리 (update)

—> 저자를 수정하는 요청을 처리(update_process)

main.js

```jsx
else if(pathname==='/author/update'){
      author.update(request, response);

    }else if(pathname ==='/author/update_process'){
      author.update_process(request,response);

    }
```

—> 저자를 수정하기 위한 폼을 요청하는 /author/update추가

—> 저자를 수정하는 요청을 처리하는 /author/update_process추가

## 19 저자 삭제 기능 구현

template.js: 저자 정보 목록에 delete링크 추가

```jsx
<td>
                      <form action="/author/delete_process" method="post">
                        <input type="hidden" name="id" value="${author[i].id}">
                        <input type="submit" value="delete">
                      </form>
                    </td>
```

author.js

```jsx
exports.delete_process = function(request, response){
  var body = '';
    request.on('data', function(data){
        body = body + data;
    });
    request.on('end', function(){
        var post = qs.parse(body);
        db.query(`
          DELETE FROM author WHERE id=?`,
          [post.id], 
          function(error, result){
            if(error){
              throw error;
            }
            response.writeHead(302, {Location: `/author`});
            response.end();
          }
        )
    });
}
```

—> 저자를 삭제하는 요청을 처리

—> DELETE 쿼리문을 사용, WHERE절을 빠뜨리면 모든 데이터가 삭제 되므로 주의(조건이 없으면 테이블의 모든 행에 대해 해당 작업을 수행하도록 설계되어 있으므로 다 삭제되는 것.)

main.js

```jsx
else if(pathname==='/author/delete_process'){
      author.delete_process(request,response);
    }
```

—> 저자를 삭제하는 요청을 처리하는 /author/delete_process추가

author.js

```jsx
exports.delete_process = function(request, response){
    var body = '';
      request.on('data', function(data){
          body = body + data;
      });
      request.on('end', function(){
          var post = qs.parse(body);
          db.query(
            `DELETE FROM topic WHERE author_id=?`,
            [post.id], 
            function(error1, result1){
                if(error1){
                    throw error1;
                }
                db.query(`
                    DELETE FROM author WHERE id=?`,
                    [post.id], 
                    function(error2, result2){
                        if(error2){
                            throw error2;
                        }
                        response.writeHead(302, {Location: `/author`});
                        response.end();
                    }
                )
            }
        );
      });
}
```

—> 저자를 삭제하면 해당 저자의 글도 함께 삭제되도록 수정

최종 main.js

```jsx
var http = require('http');
var url = require('url');
var qs = require('querystring');
var template = require('./lib/template.js');
var db = require('./lib/db.js'); //데이터베이스 접속 코드 불러오기
var topic=require('./lib/topic');// topic라이브러리에 있는 함수들 호출
var author=require('./lib/author')// author링크를 클릭하면 요청을 처리
 
var app = http.createServer(function(request,response){
    var _url = request.url;
    var queryData = url.parse(_url, true).query;
    var pathname = url.parse(_url, true).pathname;
    if(pathname === '/'){
      if(queryData.id === undefined){
        topic.home(request, response);
      } else {
        topic.page(request,response);
      }
    } else if(pathname === '/create'){
      topic.create(request,response);
    } else if(pathname === '/create_process'){
      topic.create_process(request,response);
    } else if(pathname === '/update'){
        topic.update(request,response);
      } else if(pathname === '/update_process'){
        topic.update_process(request,response);
    } else if(pathname === '/delete_process'){
        topic.delete_process(request,response);
    } else if(pathname === '/author'){
        author.home(request,response);
    }else if(pathname ==='/author/create_process'){
        author.create_process(request,response);
    } else if(pathname==='/author/update'){
      author.update(request, response);

    }else if(pathname ==='/author/update_process'){
      author.update_process(request,response);

    }else if(pathname==='/author/delete_process'){
      author.delete_process(request,response);
    }else {
      response.writeHead(404);
      response.end('Not found');
    }
});
app.listen(3000);
```

최종 author.js

```jsx
var db = require('./db');
var template = require('./template.js');
var qs=require('querystring');
var url = require('url');

//저자 목록 화면 아래에 저자를 추가하는 폼 만들기
exports.home = function(request, response){
    db.query(`SELECT * FROM topic`, function(error,topics){
        db.query(`SELECT * FROM author`, function(error2,authors){
            var title = 'author';
            var list = template.list(topics);
            var html = template.HTML(title, list,
            `
            ${template.authorTable(authors)}
            <style>
                table{
                    border-collapse: collapse;
                }
                td{
                    border:1px solid black;
                }
            </style>
            `,
            `
            <form action="/author/create_process" method="post">
              <p>
                <input type="text" name="name" placeholder="name">
              </p>
              <p>
                <textarea name="profile" placeholder="description"></textarea>
              </p>
              <p>
                <input type="submit">
              </p>
            </form>
            `
            );
            response.writeHead(200);
            response.end(html);
        });
    });
}

//저자를 추가하는 요청을 처리
 exports.create_process=function(request,response){
    var body = '';
  request.on('data', function(data){
      body = body + data;
  });
  request.on('end', function(){
      var post = qs.parse(body);
      db.query(`
        INSERT INTO author (name, profile) 
          VALUES(?, ?)`,
        [post.name, post.profile], 
        function(error, result){
          if(error){
            throw error;
          }
          response.writeHead(302, {Location: `/author`});
          response.end();
        }
      )
  });
}

// 저자를 수정하기 위한 폼을 요청하는 처리
exports.update = function(request, response){
  db.query(`SELECT * FROM topic`, function(error,topics){
      db.query(`SELECT * FROM author`, function(error2,authors){
        var _url=request.url;
        var queryData=url.parse(_url,true).query;
        db.query(`SELECT * FROM author WHERE id=?`,[queryData.id], function(error3,author){

          var title = 'author';
          var list = template.list(topics);
          var html = template.HTML(title, list,
          `
          ${template.authorTable(authors)}
          <style>
              table{
                  border-collapse: collapse;
              }
              td{
                  border:1px solid black;
              }
          </style>
          <form action="/author/update_process" method="post">
            <p>
              <input type="hidden" name="id" value="${queryData.id}">
            </p>
            <p>
               <input trpe="text name="name value="${author[0].name}" placeholder="name">
            </p>
            <p>
              <textarea name="profile" placeholder="description">${author[0].profile}</textarea>
            </p>
            <p>
              <input type="submit" value="update>
            </p>
          </form>
          `,
          ``
          );
          response.writeHead(200);
          response.end(html);
      });
    });
  });
}

//저자를 수정하는 요청을 처리
exports.update_process = function(request, response){
  var body = '';
    request.on('data', function(data){
        body = body + data;
    });
    request.on('end', function(){
        var post = qs.parse(body);
        db.query(`
          UPDATE author SET name=?, profile=? WHERE id=?`,
          [post.name, post.profile, post.id], 
          function(error, result){
            if(error){
              throw error;
            }
            response.writeHead(302, {Location: `/author`});
            response.end();
          }
        )
    });
}

// 저자를 삭제하는 요청을 처리
// 저자를 삭제하면 해당 저자의 글도 함께 삭제하도록 수정
exports.delete_process = function(request, response){
  var body = '';
    request.on('data', function(data){
        body = body + data;
    });
    request.on('end', function(){
        var post = qs.parse(body);
        db.query(
          `DELETE FROM topic WHERE author_id=?`,
          [post.id], 
          function(error1, result1){
              if(error1){
                  throw error1;
              }
              db.query(`
                  DELETE FROM author WHERE id=?`,
                  [post.id], 
                  function(error2, result2){
                      if(error2){
                          throw error2;
                      }
                      response.writeHead(302, {Location: `/author`});
                      response.end();
                  }
              )
          }
      );
    });
}
```

최종 template.js

```jsx
module.exports = {
    HTML:function(title, list, body, control){
      return `
      <!doctype html>
      <html>
      <head>
        <title>WEB1 - ${title}</title>
        <meta charset="utf-8">
      </head>
      <body>
        <h1><a href="/">WEB</a></h1>
        <a href="/author">author</a>
        ${list}
        ${control}
        ${body}
      </body>
      </html>
      `;
    },list:function(topics){
      var list = '<ul>';
      var i = 0;
      while(i < topics.length){
        list = list + `<li><a href="/?id=${topics[i].id}">${topics[i].title}</a></li>`;
        i = i + 1;
      }
      list = list+'</ul>';
      return list;
    },authorSelect:function(authors, author_id) {
      var tag = '';
      var i = 0;
      while(i < authors.length){
        var selected='';
        if(authors[i].id ===author_id){
            selected='selected';
          }
        tag += `<option value="${authors[i].id}"${selected}>${authors[i].name}</option>`;
        i++;
      }
      return `
        <select name="author">
          ${tag}
        </select>
      `
      } ,authorTable:function(authors){
        var tag = '<table>';
        var i = 0;
        while(i < authors.length){
            tag += `
                <tr>
                    <td>${authors[i].name}</td>
                    <td>${authors[i].profile}</td>
                    <td><a href="/author/update?id=${authors[i].id}">update</a></td>
                    <td>
                      <form action="/author/delete_process" method="post">
                        <input type="hidden" name="id" value="${authors[i].id}">
                        <input type="submit" value="delete">
                      </form>
                    </td>
                </tr>
                `
            i++;
        }
        tag += '</table>';
        return tag;
      }
    }
  
```

## 20 보안: SQL 인젝션

Node.js와 데이터베이스를 연동해서 사용할 때 생길 수 있는 보안

- 외부로부터 유입되는 정보(데이터: 웹 애플리케이션에서 글 목록 중 사용자의 클릭으로 유입되는 쿼리 스트링, 생성이나 수정 기능에서 사용자가 입력하는 데이터 등)는 오염됐을 것으로 생각

**세미콜론(;): 한 명령이 끝났다는 표시**

SQL문을 입력하고 세미콜론을 입력하고 그 뒤에 또 입력하면 두 개의 명령이 실행됨 

—>웹 브라우저 주소 표시줄에 http://localhost:3000/?id=2; 이렇게 나왔는데 이 뒤에 어떤 공격자가 DROP TABLE topic;이거 입력하면 다 날아갈 수 있는 것. 

—> 그러나 공격을 의도한 SQL문이 topic.id값에 작은 따옴표로 묶여서 들어감 → 작은 따옴표 안의 문자열은 SQL문이 아닌 일반 텍스트 문자열이므로 해당 SQL문은 실행되지 않고 공격 실패.

**SQL 인젝션: 웹 애플리케이션의 사용자 입력값을 이용해 데이터베이스에 SQL문을 주입해서 공격하는 기법.**

- 애플리케이션에서 사용자 입력값을 이용하여 데이터베이스에 질의할 때 SQL문에 물음표로 지정한 후 인수로 전달하는 방식으로 구현하면 SQL인젝션 공격을 막을 수 있음.
- ? (플레이스홀더) 의미: 쿼리 실행 시 동적으로 값을 대체할 자리 표시자
사용 이유: 쿼리의 동적 데이터를 안전하게 삽입하기 위해
장점: SQL 인젝션 공격을 방지할 수 있음.

## 21 보안: 이스케이프

내부에 저장된 데이터가 사용자에게 전달(웹 페이지 표시)될 때 발생할 수 있는 공격 유형과 이를 막는 이스케이핑이라는 방어 기법

author.js

```jsx
var db = require('./db');
var template = require('./template.js');
var qs=require('querystring');
var url = require('url');
var sanitizeHtml=require('sanitize-html');

//저자 목록 화면 아래에 저자를 추가하는 폼 만들기
exports.home = function(request, response){
    db.query(`SELECT * FROM topic`, function(error,topics){
        db.query(`SELECT * FROM author`, function(error2,authors){
            var title = 'author';
            var list = template.list(topics);
            var html = template.HTML(title, list,
            `
            ${template.authorTable(authors)}
            <style>
                table{
                    border-collapse: collapse;
                }
                td{
                    border:1px solid black;
                }
            </style>
            `,
            `
            <form action="/author/create_process" method="post">
              <p>
                <input type="text" name="name" placeholder="name">
              </p>
              <p>
                <textarea name="profile" placeholder="description"></textarea>
              </p>
              <p>
                <input type="submit">
              </p>
            </form>
            `
            );
            response.writeHead(200);
            response.end(html);
        });
    });
}

//저자를 추가하는 요청을 처리
 exports.create_process=function(request,response){
    var body = '';
  request.on('data', function(data){
      body = body + data;
  });
  request.on('end', function(){
      var post = qs.parse(body);
      db.query(`
        INSERT INTO author (name, profile) 
          VALUES(?, ?)`,
        [post.name, post.profile], 
        function(error, result){
          if(error){
            throw error;
          }
          response.writeHead(302, {Location: `/author`});
          response.end();
        }
      )
  });
}

// 저자를 수정하기 위한 폼을 요청하는 처리
exports.update = function(request, response){
  db.query(`SELECT * FROM topic`, function(error,topics){
      db.query(`SELECT * FROM author`, function(error2,authors){
        var _url=request.url;
        var queryData=url.parse(_url,true).query;
        db.query(`SELECT * FROM author WHERE id=?`,[queryData.id], function(error3,author){

          var title = 'author';
          var list = template.list(topics);
          var html = template.HTML(title, list,
          `
          ${template.authorTable(authors)}
          <style>
              table{
                  border-collapse: collapse;
              }
              td{
                  border:1px solid black;
              }
          </style>
          <form action="/author/update_process" method="post">
            <p>
              <input type="hidden" name="id" value="${queryData.id}">
            </p>
            <p>
               <input trpe="text name="name value="${sanitizeHtml(author[0].name)}" placeholder="name">  //5. 데이터를 표시하는 코드를 sanitizeHtml함수로 감싸
            </p>
            <p>
              <textarea name="profile" placeholder="description">${sanitizeHtml(author[0].profile)}</textarea>
            </p>
            <p>
              <input type="submit" value="update>
            </p>
          </form>
          `,
          ``
          );
          response.writeHead(200);
          response.end(html);
      });
    });
  });
}

//저자를 수정하는 요청을 처리
exports.update_process = function(request, response){
  var body = '';
    request.on('data', function(data){
        body = body + data;
    });
    request.on('end', function(){
        var post = qs.parse(body);
        db.query(`
          UPDATE author SET name=?, profile=? WHERE id=?`,
          [post.name, post.profile, post.id], 
          function(error, result){
            if(error){
              throw error;
            }
            response.writeHead(302, {Location: `/author`});
            response.end();
          }
        )
    });
}

// 저자를 삭제하는 요청을 처리
// 저자를 삭제하면 해당 저자의 글도 함께 삭제하도록 수정
exports.delete_process = function(request, response){
  var body = '';
    request.on('data', function(data){
        body = body + data;
    });
    request.on('end', function(){
        var post = qs.parse(body);
        db.query(
          `DELETE FROM topic WHERE author_id=?`,
          [post.id], 
          function(error1, result1){
              if(error1){
                  throw error1;
              }
              db.query(`
                  DELETE FROM author WHERE id=?`,
                  [post.id], 
                  function(error2, result2){
                      if(error2){
                          throw error2;
                      }
                      response.writeHead(302, {Location: `/author`});
                      response.end();
                  }
              )
          }
      );
    });
}
```

topic.js

```jsx
var db=require('./db.js'); //여기에서 db와 template객체를 사용할 수 있게 불러오기 , 같은 lib디렉토리에 존재하므로 경로 지정할 떄 lib는 제외함.
var template=require('./template.js');
var url=require('url'); 
var qs=require('querystring');
var sanitizeHtml=require('sanitize-html');

//main.js에서 글(topic)과 관련된 코드 --> home이라는 이름의 함수로 만들어 사용

exports.home=function(request, response) {
    db.query(`SELECT * FROM topic`, function(error,topics){
        var title = 'Welcome';
        var description = 'Hello, Node.js';
        var list = template.list(topics);
        var html = template.HTML(title, list,
          `<h2>${title}</h2>${description}`,
          `<a href="/create">create</a>`
        );
        response.writeHead(200);
        response.end(html);
      });
}

// main.js에서 상세 보기 페이지의 코드
exports.page=function(request,response){
    var _url = request.url;
    var queryData=url.parse(_url, true).query;
    db.query(`SELECT * FROM topic`, function(error,topics){
        if(error){
          throw error;
        }
        db.query(`SELECT * FROM topic LEFT JOIN author ON topic.author_id=author.id WHERE topic.id=?`,[queryData.id], function(error2, topic){
          if(error2){
            throw error2;
          }
          console.log(topic);
         var title = topic[0].title;
         var description = topic[0].description;
         var list = template.list(topics);
         var html = template.HTML(title, list,
           `<h2>${title}</h2>
           ${description}
           <p>by ${topic[0].name}</p>`,
           ` <a href="/create">create</a>
               <a href="/update?id=${queryData.id}">update</a>
               <form action="delete_process" method="post">
                 <input type="hidden" name="id" value="${queryData.id}">
                 <input type="submit" value="delete">
               </form>`
         );
         response.writeHead(200);
         response.end(html);
        });
     });
    }
   

    //main.js에서 글 생성 화면 코드
    exports.create=function(request,response){
        db.query(`SELECT * FROM topic`, function(error,topics){
            db.query('SELECT * FROM author', function(error2,authors){
            var title = 'Create';
            var list = template.list(topics);
            var html = template.HTML(sanitizeHtml(title), list, // 1. 데이터를 표시하는 코드를 sanitizeHtml함수로 감싸기
               `
              <form action="/create_process" method="post">
                <p><input type="text" name="title" placeholder="title"></p>
                <p>
                  <textarea name="description" placeholder="description"></textarea>
                </p>
                <p>
                  ${template.authorSelect(authors)}
                </p>
                <p>
                  <input type="submit">
                </p>
              </form>
              `,
              `<a href="/create">create</a>`
            );
            response.writeHead(200);
            response.end(html);
           });
    
        });
    }

    // main.js에서 글 생성을 처리하는 코드
    exports.create_process=function(request,response){
        var body = '';
      request.on('data', function(data){
          body = body + data;
      });
      request.on('end', function(){
          var post = qs.parse(body);
          db.query(`
            INSERT INTO topic (title, description, created, author_id) 
              VALUES(?, ?, NOW(), ?)`,
            [post.title, post.description, post.author], 
            function(error, result){
              if(error){
                throw error;
              }
              response.writeHead(302, {Location: `/?id=${result.insertId}`});
              response.end();
            }
          )
      });
    }

    //main.js에서 글 수정 화면의 코드
    exports.update=function(request,response){
        var _url=request.url;
        var queryData=url.parse(_url,true).query;
        db.query('SELECT * FROM topic', function(error, topics){
            if(error){
              throw error;
            }
            db.query(`SELECT * FROM topic WHERE id=?`,[queryData.id], function(error2, topic){
              if(error2){
                throw error2;
              }
              db.query(`SELECT * FROM author`, function(error2,authors) {
              var list = template.list(topics);
              var html = template.HTML(sanitizeHtml(topic[0].title), list,   //3. 데이터를 표시하는 코드를 sanitizeHtml함수로 감기
                `
                <form action="/update_process" method="post">
                  <input type="hidden" name="id" value="${topic[0].id}">
                  <p><input type="text" name="title" placeholder="title" value="${topic[0].title}"></p>
                  <p>
                    <textarea name="description" placeholder="description">${topic[0].description}</textarea>
                  </p>
                  <p>
                    ${template.authorSelect(authors, topic[0].author_id)}
                    </p>
                  <p>
                    <input type="submit">
                  </p>
                </form>
                `,
                `<a href="/create">create</a> <a href="/update?id=${topic[0].id}">update</a>`
              );
              response.writeHead(200);
              response.end(html);
               });
            });
          });
    }

    //main.js에서 글 수정을 처리하는 코드
    exports.update_process=function(request,response){
        var body = '';
        request.on('data', function(data){
            body = body + data;
        });
        request.on('end', function(){
            var post = qs.parse(body);
            db.query('UPDATE topic SET title=?, description=?, author_id=? WHERE id=?', [post.title, post.description, post.author, post.id], function(error, result){
              response.writeHead(302, {Location: `/?id=${post.id}`});
              response.end();
            })
        });
    }

    //main.js에서 글 삭제를 처리하는 코드
    exports.delete_process=function(request,response){
        var body = '';
        request.on('data', function(data){
            body = body + data;
        });
        request.on('end', function(){
            var post = qs.parse(body);
            db.query('DELETE FROM topic WHERE id = ?', [post.id], function(error, result){
              if(error){
                throw error;
              }
              response.writeHead(302, {Location: `/`});
              response.end();
            });
        });

    }

```

template.js

```jsx
var sanitizeHtml=require('sanitize-html');

module.exports = {
    HTML:function(title, list, body, control){
      return `
      <!doctype html>
      <html>
      <head>
        <title>WEB1 - ${title}</title>
        <meta charset="utf-8">
      </head>
      <body>
        <h1><a href="/">WEB</a></h1>
        <a href="/author">author</a>
        ${list}
        ${control}
        ${body}
      </body>
      </html>
      `;
    },list:function(topics){
      var list = '<ul>';
      var i = 0;
      while(i < topics.length){
        list = list + `<li><a href="/?id=${sanitizeHtml(topics[i].id)}">${topics[i].title}</a></li>`; //2. 데이터를 표시하는 코드를 sanitizeHtml함수로 감싸기
        i = i + 1;
      }
      list = list+'</ul>';
      return list;
    },authorSelect:function(authors, author_id) {
      var tag = '';
      var i = 0;
      while(i < authors.length){
        var selected='';
        if(authors[i].id ===author_id){
            selected='selected';
          }
        tag += `<option value="${authors[i].id}"${selected}>${sanitizeHtml(authors[i].name)}</option>`;
        i++;
      }
      return `
        <select name="author">
          ${tag}
        </select>
      `
      } ,authorTable:function(authors){
        var tag = '<table>';
        var i = 0;
        while(i < authors.length){
            tag += `
                <tr>
                    <td>${sanitizeHtml(authors[i].name)}</td>     //4. 데이터를 표시하는 코드를 sanitizeHtml함수로 감싸기
                    <td>${sanitizeHtml(authors[i].profile)}</td>
                    <td><a href="/author/update?id=${authors[i].id}">update</a></td>
                    <td>
                      <form action="/author/delete_process" method="post">
                        <input type="hidden" name="id" value="${authors[i].id}">
                        <input type="submit" value="delete">
                      </form>
                    </td>
                </tr>
                `
            i++;
        }
        tag += '</table>';
        return tag;
      }
    }
  
```

⇒ 저장된 정보를 사용자에게 출력할 때 공격 의도를 담을 수 있는 스크립트를 sanitizeHtml라이브러리를 이용해서 막는 방법을 본 것.
